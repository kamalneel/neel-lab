<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../faviconV4.png">
  <title>401k Pundit - When Enough is Enough - Neel Labs</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --color-bg-primary: #0D0D0D;
      --color-bg-secondary: #1A1A1A;
      --color-bg-tertiary: #242424;
      --color-text-primary: #FFFFFF;
      --color-text-secondary: #A3A3A3;
      --color-text-tertiary: #737373;
      --color-accent: #00D632;
      --color-accent-hover: #00E639;
      --color-accent-muted: rgba(0, 214, 50, 0.12);
      --color-gold: #C9A227;
      --color-gold-muted: rgba(201, 162, 39, 0.15);
      --color-blue: #3B82F6;
      --color-blue-muted: rgba(59, 130, 246, 0.15);
      --color-red: #EF4444;
      --color-red-muted: rgba(239, 68, 68, 0.12);
      --color-border: rgba(255, 255, 255, 0.08);
      --font-sans: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-display: 'Space Grotesk', 'Outfit', sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-12: 3rem;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      -webkit-font-smoothing: antialiased;
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-sans);
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }

    /* Header */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(13, 13, 13, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-3) var(--space-6);
    }

    .app-header-container {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .app-logo img {
      height: 40px;
      border-radius: var(--radius-md);
    }

    .app-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .app-title span { color: var(--color-blue); }

    .back-link {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
    }

    .back-link:hover {
      color: var(--color-accent);
      border-color: rgba(0, 214, 50, 0.3);
      background: var(--color-accent-muted);
    }

    /* Main */
    .app-main {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--space-8) var(--space-6);
    }

    /* Hero Section */
    .hero-section {
      text-align: center;
      padding: var(--space-12) 0;
      margin-bottom: var(--space-8);
    }

    .hero-badge {
      display: inline-block;
      background: var(--color-blue-muted);
      color: var(--color-blue);
      padding: var(--space-2) var(--space-4);
      border-radius: 100px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: var(--space-6);
    }

    .hero-title {
      font-family: var(--font-display);
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: var(--space-6);
    }

    .hero-title .accent { color: var(--color-accent); }

    .hero-subtitle {
      font-size: 1.25rem;
      color: var(--color-text-secondary);
      max-width: 600px;
      margin: 0 auto var(--space-8);
      line-height: 1.7;
    }

    /* Input Card */
    .input-card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      max-width: 700px;
      margin: 0 auto;
    }

    .input-card h3 {
      font-family: var(--font-display);
      font-size: 1.25rem;
      margin-bottom: var(--space-6);
      text-align: center;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-6);
      margin-bottom: var(--space-6);
    }

    @media (max-width: 700px) {
      .input-grid { grid-template-columns: 1fr; }
    }

    .input-group { text-align: center; }

    .input-group label {
      display: block;
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
    }

    .input-group input {
      width: 100%;
      padding: var(--space-4);
      background: var(--color-bg-tertiary);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      color: var(--color-text-primary);
      font-family: var(--font-mono);
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 4px var(--color-accent-muted);
    }

    .input-group .hint {
      font-size: 0.75rem;
      color: var(--color-text-tertiary);
      margin-top: var(--space-2);
    }

    /* Withdrawal Input Section */
    .withdrawal-input-section {
      margin-top: var(--space-6);
      padding-top: var(--space-6);
      border-top: 1px solid var(--color-border);
    }

    .withdrawal-input-section label {
      display: block;
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
      text-align: center;
    }

    .withdrawal-controls {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      justify-content: center;
    }

    .withdrawal-btn {
      width: 80px;
      padding: var(--space-3);
      background: var(--color-bg-tertiary);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      color: var(--color-text-secondary);
      font-family: var(--font-mono);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .withdrawal-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: var(--color-accent-muted);
    }

    .withdrawal-controls input {
      width: 180px;
      padding: var(--space-3);
      background: var(--color-bg-tertiary);
      border: 2px solid var(--color-accent);
      border-radius: var(--radius-lg);
      color: var(--color-accent);
      font-family: var(--font-mono);
      font-size: 1.75rem;
      font-weight: 700;
      text-align: center;
      transition: all 0.2s ease;
    }

    .withdrawal-controls input:focus {
      outline: none;
      box-shadow: 0 0 0 4px var(--color-accent-muted);
    }

    .withdrawal-breakdown {
      text-align: center;
      font-size: 0.8rem;
      color: var(--color-text-tertiary);
      margin-top: var(--space-3);
    }

    .withdrawal-breakdown span {
      color: var(--color-text-secondary);
      font-family: var(--font-mono);
    }

    /* Quick Presets (Compact) */
    .quick-presets {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      margin-top: var(--space-4);
      flex-wrap: wrap;
    }

    .quick-presets-label {
      font-size: 0.8rem;
      color: var(--color-text-tertiary);
    }

    .quick-preset-btn {
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 100px;
      color: var(--color-text-secondary);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-preset-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: var(--color-accent-muted);
    }

    .quick-preset-btn.active {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: var(--color-accent-muted);
    }

    .quick-preset-btn.recommended {
      border-color: var(--color-gold);
      color: var(--color-gold);
    }

    .quick-preset-btn.recommended:hover,
    .quick-preset-btn.recommended.active {
      background: var(--color-gold-muted);
    }

    /* Inflation Toggle */
    .inflation-toggle {
      margin-top: var(--space-4);
      padding: var(--space-4) var(--space-6);
      background: var(--color-bg-tertiary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-6);
    }

    .toggle-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    .toggle-label input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      display: block;
      position: relative;
      width: 48px;
      min-width: 48px;
      height: 26px;
      background: var(--color-bg-primary);
      border: 2px solid var(--color-border);
      border-radius: 100px;
      transition: all 0.2s ease;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: var(--color-text-tertiary);
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .toggle-label input:checked + .toggle-slider {
      background: var(--color-accent-muted);
      border-color: var(--color-accent);
    }

    .toggle-label input:checked + .toggle-slider::before {
      transform: translateX(22px);
      background: var(--color-accent);
    }

    .toggle-label:hover .toggle-slider {
      border-color: var(--color-accent);
    }

    .toggle-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      user-select: none;
    }

    .toggle-title {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--color-text-primary);
    }

    .toggle-desc {
      font-size: 0.8rem;
      color: var(--color-text-tertiary);
    }

    .calculate-btn {
      width: 100%;
      padding: var(--space-4);
      background: var(--color-accent);
      color: #000;
      border: none;
      border-radius: var(--radius-lg);
      font-family: var(--font-sans);
      font-size: 1.125rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .calculate-btn:hover {
      background: var(--color-accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 214, 50, 0.3);
    }

    /* Results Section */
    .results-section {
      display: none;
      margin-top: var(--space-12);
    }

    .results-section.visible {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Section Titles */
    .section-title {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: var(--space-6);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .section-title .number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--color-blue);
      color: #000;
      border-radius: 50%;
      font-size: 0.875rem;
      font-weight: 700;
    }

    /* Cards */
    .card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-8);
    }

    .card h4 {
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: var(--space-3) var(--space-4);
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    .data-table th {
      color: var(--color-text-tertiary);
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .data-table td {
      font-family: var(--font-mono);
      font-size: 0.95rem;
    }

    .data-table td:last-child {
      text-align: right;
      font-weight: 600;
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table .total-row td {
      border-top: 2px solid var(--color-border);
      font-weight: 700;
      font-size: 1.1rem;
      padding-top: var(--space-4);
    }

    .data-table .highlight { color: var(--color-accent); }
    .data-table .blue { color: var(--color-blue); }
    .data-table .gold { color: var(--color-gold); }
    .data-table .red { color: var(--color-red); }

    /* Assumptions Grid */
    .assumptions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--space-4);
    }

    .assumption-item {
      background: var(--color-bg-tertiary);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      text-align: center;
    }

    .assumption-item .value {
      font-family: var(--font-mono);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .assumption-item .label {
      font-size: 0.7rem;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: var(--space-1);
    }

    /* Big Number Display */
    .big-number {
      text-align: center;
      padding: var(--space-6);
      background: var(--color-bg-tertiary);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
    }

    .big-number .label {
      font-size: 0.875rem;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: var(--space-2);
    }

    .big-number .amount {
      font-family: var(--font-mono);
      font-size: 3rem;
      font-weight: 700;
    }

    .big-number .amount.green { color: var(--color-accent); }
    .big-number .amount.blue { color: var(--color-blue); }
    .big-number .amount.gold { color: var(--color-gold); }
    .big-number .amount.red { color: var(--color-red); }

    .big-number .subtitle {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-top: var(--space-2);
    }

    /* Chart */
    .chart-container {
      height: 400px;
      position: relative;
      margin-top: var(--space-6);
    }

    /* THE ANSWER - 3 Scenarios Section */
    .answer-section {
      background: linear-gradient(135deg, #1a1a2e 0%, #0D0D0D 100%);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      margin-bottom: var(--space-8);
    }

    .answer-header {
      text-align: center;
      margin-bottom: var(--space-8);
    }

    .answer-badge {
      display: inline-block;
      background: var(--color-accent);
      color: #000;
      padding: var(--space-2) var(--space-6);
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      margin-bottom: var(--space-4);
    }

    .answer-header h2 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--color-text-secondary);
      margin: 0;
    }

    .scenarios-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    @media (max-width: 800px) {
      .scenarios-grid {
        grid-template-columns: 1fr;
      }
    }

    .scenario-card {
      background: var(--color-bg-tertiary);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      text-align: center;
      position: relative;
    }

    .scenario-card.primary {
      border-color: var(--color-accent);
      background: linear-gradient(135deg, var(--color-accent-muted), var(--color-bg-tertiary));
    }

    .scenario-card.warning {
      border-color: var(--color-red);
      background: linear-gradient(135deg, var(--color-red-muted), var(--color-bg-tertiary));
    }

    .scenario-card.danger {
      border-color: var(--color-red);
      background: linear-gradient(135deg, var(--color-red-muted), var(--color-bg-tertiary));
    }

    .scenario-card.danger .scenario-recommend-badge {
      background: var(--color-red);
    }

    .scenario-card.danger .scenario-main-answer {
      color: var(--color-red);
    }

    .scenario-card.bonus {
      border-color: var(--color-gold);
      background: linear-gradient(135deg, var(--color-gold-muted), var(--color-bg-tertiary));
    }

    .scenario-card.success {
      border-color: var(--color-accent);
      background: linear-gradient(135deg, var(--color-accent-muted), var(--color-bg-tertiary));
    }

    .scenario-card.info {
      border-color: var(--color-blue);
      background: linear-gradient(135deg, var(--color-blue-muted), var(--color-bg-tertiary));
    }

    .scenario-card.info .scenario-recommend-badge {
      background: var(--color-blue);
    }

    .scenario-card.info .scenario-main-answer {
      color: var(--color-blue);
    }

    .result-text.info {
      color: var(--color-blue);
    }

    .scenario-recommend-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-accent);
      color: #000;
      font-size: 0.625rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 100px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .scenario-title {
      font-size: 0.875rem;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-3);
    }

    .scenario-result {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }

    .scenario-result .result-icon {
      font-size: 1.5rem;
    }

    .scenario-result .result-text {
      font-family: var(--font-mono);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-red);
    }

    .scenario-result.bonus .result-text {
      color: var(--color-gold);
    }

    .scenario-result .result-text.success {
      color: var(--color-accent);
    }

    .scenario-result.success .result-text {
      color: var(--color-accent);
    }

    .scenario-main-answer {
      font-family: var(--font-mono);
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--color-accent);
      line-height: 1;
      margin-bottom: var(--space-2);
    }

    .scenario-subtext {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    .scenario-stats {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .scenario-stat {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
    }

    .scenario-stat .stat-label {
      color: var(--color-text-tertiary);
    }

    .scenario-stat .stat-value {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .answer-footer {
      text-align: center;
      font-size: 0.875rem;
      color: var(--color-text-tertiary);
    }

    .answer-footer strong {
      color: var(--color-gold);
    }

    /* Details Toggle */
    .details-toggle {
      text-align: center;
      margin-bottom: var(--space-6);
    }

    .toggle-details-btn {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .toggle-details-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .detailed-calculations {
      display: none;
    }

    .detailed-calculations.visible {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* Footer */
    .app-footer {
      background: var(--color-bg-secondary);
      border-top: 1px solid var(--color-border);
      padding: var(--space-6);
      margin-top: var(--space-12);
      text-align: center;
      font-size: 0.875rem;
      color: var(--color-text-tertiary);
    }

    .app-footer a { color: var(--color-accent); }

    .disclaimer {
      max-width: 700px;
      margin: 0 auto var(--space-4);
      padding: var(--space-4);
      background: var(--color-bg-tertiary);
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      line-height: 1.6;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .hero-title { font-size: 2rem; }
      .big-number .amount { font-size: 2rem; }
      .assumptions-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="app-header-container">
      <div class="app-header-left">
        <a href="/" class="app-logo">
          <img src="../LogoV2.png" alt="Neel Labs">
        </a>
        <span class="app-title">401k <span>Pundit</span></span>
      </div>
      <a href="/" class="back-link">Back to Neel Labs</a>
    </div>
  </header>

  <main class="app-main">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-badge">Retirement Planning</div>
      <h1 class="hero-title">
        When <span class="accent">Enough</span><br>is Enough
      </h1>
      <p class="hero-subtitle">
        Everyone tells you to max out your 401k. But at what point have you saved
        <em>enough</em> for retirement? This calculator finds that magic number.
      </p>
    </section>

    <!-- Input Card -->
    <div class="input-card">
      <h3>Enter Your Current Retirement Savings</h3>

      <div class="input-grid">
        <div class="input-group">
          <label>Your Current Age</label>
          <input type="number" id="currentAge" value="40" min="25" max="59" onchange="updateFromMonthlyInput()">
          <div class="hint">You (or younger spouse)</div>
        </div>

        <div class="input-group">
          <label>Combined IRA Balance</label>
          <input type="text" id="iraBalance" value="400,000" oninput="formatNumber(this)">
          <div class="hint">You + Spouse (rolled 401k)</div>
        </div>

        <div class="input-group">
          <label>Combined Roth IRA</label>
          <input type="text" id="rothBalance" value="100,000" oninput="formatNumber(this)">
          <div class="hint">You + Spouse</div>
        </div>
      </div>

      <div class="withdrawal-input-section">
        <label id="spendingLabel">Monthly Spending in Retirement (Today's Dollars, After Taxes)</label>
        <div class="withdrawal-controls">
          <button class="withdrawal-btn" onclick="adjustMonthlySpending(-1000)">âˆ’$1K</button>
          <input type="text" id="monthlySpendingInput" value="20,000" class="monthly-input" oninput="formatNumber(this); clearPresetSelection(); updateFromMonthlyInput()">
          <button class="withdrawal-btn" onclick="adjustMonthlySpending(1000)">+$1K</button>
        </div>

        <!-- Inflation Toggle - Prominent position -->
        <div class="inflation-toggle">
          <label class="toggle-label">
            <input type="checkbox" id="inflationToggle" checked onchange="updateFromMonthlyInput(); calculate();">
            <span class="toggle-slider"></span>
          </label>
          <div class="toggle-content">
            <span class="toggle-title">Inflation-Adjusted</span>
            <span class="toggle-desc">Spending increases 3%/year during retirement</span>
          </div>
        </div>

        <div class="withdrawal-breakdown" id="inflationNote">
          At 3% inflation â†’ <span id="futureMonthlyDisplay">$36K</span>/mo in <span id="yearsToRetireDisplay">20</span> years
        </div>
        <div class="withdrawal-breakdown">
          Requires: <span id="iraWithdrawalDisplay">$230K</span> IRA + <span id="rothWithdrawalDisplay">$58K</span> Roth = <span id="totalWithdrawalDisplay">$288K</span>/year
        </div>
      </div>

      <!-- Quick Presets (Compact) -->
      <div class="quick-presets">
        <span class="quick-presets-label">Quick pick:</span>
        <button class="quick-preset-btn" onclick="setMonthlyPreset(5000, this)" title="10% tax bracket">$5K/mo</button>
        <button class="quick-preset-btn" onclick="setMonthlyPreset(10000, this)" title="12% tax bracket">$10K/mo</button>
        <button class="quick-preset-btn recommended" onclick="setMonthlyPreset(15000, this)" title="Sweet spot">$15K/mo</button>
        <button class="quick-preset-btn" onclick="setMonthlyPreset(20000, this)" title="22% tax bracket">$20K/mo</button>
      </div>

      <button class="calculate-btn" onclick="calculate()">
        Show Me the Numbers
      </button>
    </div>

    <!-- Results Section -->
    <section class="results-section" id="results">

      <!-- THE ANSWER - 3 Scenarios Comparison -->
      <div class="answer-section" id="answerSection">
        <div class="answer-header">
          <span class="answer-badge">THE ANSWER</span>
          <h2>When Should You Stop Contributing?</h2>
        </div>

        <div class="scenarios-grid">
          <!-- Scenario 1: If You Stop Now -->
          <div class="scenario-card" id="scenarioStopNow">
            <div class="scenario-title">If You Stop Today</div>
            <div class="scenario-result" id="stopNowResult">
              <span class="result-icon">âš ï¸</span>
              <span class="result-text">Run out at age 87</span>
            </div>
            <div class="scenario-stats">
              <div class="scenario-stat">
                <span class="stat-label">Balance at 60</span>
                <span class="stat-value" id="stopNowBalance60">$2.5M</span>
              </div>
              <div class="scenario-stat">
                <span class="stat-label">Remaining at 90</span>
                <span class="stat-value" id="stopNowRemaining90">$0</span>
              </div>
            </div>
          </div>

          <!-- Scenario 2: Minimum Needed (THE ANSWER) -->
          <div class="scenario-card primary" id="scenarioMinimum">
            <div class="scenario-recommend-badge">Minimum Needed</div>
            <div class="scenario-title">Contribute Until</div>
            <div class="scenario-main-answer" id="minimumAnswer">Age 47</div>
            <div class="scenario-subtext" id="minimumSubtext">1 more year of contributions</div>
            <div class="scenario-stats">
              <div class="scenario-stat">
                <span class="stat-label">Balance at 60</span>
                <span class="stat-value" id="minimumBalance60">$2.6M</span>
              </div>
              <div class="scenario-stat">
                <span class="stat-label">Remaining at 90</span>
                <span class="stat-value" id="minimumRemaining90">$354K</span>
              </div>
            </div>
          </div>

          <!-- Scenario 3: If You Continue to 60 -->
          <div class="scenario-card" id="scenarioContinue">
            <div class="scenario-title" id="continueHeader">If You Continue to 60</div>
            <div class="scenario-result bonus" id="continueResult">
              <span class="result-icon">ğŸ¯</span>
              <span class="result-text">$10.5M cushion</span>
            </div>
            <div class="scenario-stats">
              <div class="scenario-stat">
                <span class="stat-label" id="continueLabel60">Balance at 60</span>
                <span class="stat-value" id="continueBalance60">$3.6M</span>
              </div>
              <div class="scenario-stat">
                <span class="stat-label" id="continueLabel90">Remaining at 90</span>
                <span class="stat-value" id="continueRemaining90">$10.5M</span>
              </div>
            </div>
          </div>
        </div>

        <div class="answer-footer" id="answerFooter">
          Based on <strong id="answerMonthlySpending">$20K</strong>/month in today's dollars (<span id="answerFutureMonthly">$36K</span>/mo at 60 after 3% inflation) from age 60-90
        </div>
      </div>

      <!-- Detailed Calculations Below -->
      <div class="details-toggle">
        <button class="toggle-details-btn" onclick="toggleDetails()">
          <span id="toggleIcon">â–¼</span> Show Detailed Calculations
        </button>
      </div>

      <div class="detailed-calculations" id="detailedCalculations">

      <!-- 1. Assumptions -->
      <h2 class="section-title"><span class="number">1</span> Our Assumptions</h2>
      <div class="card">
        <div class="assumptions-grid">
          <div class="assumption-item">
            <div class="value">60</div>
            <div class="label">Retirement Age</div>
          </div>
          <div class="assumption-item">
            <div class="value">90</div>
            <div class="label">Life Expectancy</div>
          </div>
          <div class="assumption-item">
            <div class="value">8%</div>
            <div class="label">Annual Growth</div>
          </div>
          <div class="assumption-item">
            <div class="value">3%</div>
            <div class="label">Inflation Rate</div>
          </div>
          <div class="assumption-item">
            <div class="value">$47K</div>
            <div class="label">Annual IRA/401k</div>
          </div>
          <div class="assumption-item">
            <div class="value">$14K</div>
            <div class="label">Annual Roth IRA</div>
          </div>
          <div class="assumption-item">
            <div class="value">80/20</div>
            <div class="label">IRA/Roth Withdrawal</div>
          </div>
          <div class="assumption-item">
            <div class="value" id="assumptionTaxRate">~33%</div>
            <div class="label">Effective Tax (Fed+CA)</div>
          </div>
        </div>
      </div>

      <!-- 2. Your Current Balances -->
      <h2 class="section-title"><span class="number">2</span> Your Current Balances</h2>
      <div class="card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Account</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Traditional IRA (You + Spouse)</td>
              <td id="tableIRA">$800,000</td>
            </tr>
            <tr>
              <td>Roth IRA (You + Spouse)</td>
              <td id="tableRoth">$50,000</td>
            </tr>
            <tr class="total-row">
              <td>Total Current Retirement Savings</td>
              <td class="highlight" id="tableTotal">$850,000</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 3. Projection to Age 60 -->
      <h2 class="section-title"><span class="number">3</span> Growing Your Nest Egg to Age 60</h2>
      <div class="card">
        <table class="data-table">
          <thead>
            <tr>
              <th>Component</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Current Balance</td>
              <td id="projCurrentBalance">$850,000</td>
            </tr>
            <tr>
              <td>Growth on Current Balance (8% for <span id="projYears">14</span> years)</td>
              <td class="blue" id="projGrowthOnCurrent">+$1,648,000</td>
            </tr>
            <tr>
              <td>Future Contributions ($61K/yr Ã— <span id="projYears2">14</span> years)</td>
              <td id="projContributions">$658,000</td>
            </tr>
            <tr>
              <td>Growth on Contributions</td>
              <td class="blue" id="projGrowthOnContrib">+$466,000</td>
            </tr>
            <tr class="total-row">
              <td>Projected Balance at Age 60</td>
              <td class="highlight" id="projTotal">$3,622,000</td>
            </tr>
          </tbody>
        </table>

        <div class="big-number" style="margin-top: var(--space-6);">
          <div class="label">Your Nest Egg at 60</div>
          <div class="amount blue" id="bigNestEgg">$3.6M</div>
        </div>
      </div>

      <!-- 4. Retirement Spending (60-90) -->
      <h2 class="section-title"><span class="number">4</span> Your Retirement Lifestyle (Age 60-90)</h2>
      <div class="card">
        <div id="inflationNoteBox" style="margin-bottom: var(--space-4); padding: var(--space-4); background: var(--color-gold-muted); border-radius: var(--radius-md); font-size: 0.85rem; color: var(--color-text-secondary);">
          <strong style="color: var(--color-gold);">Inflation Adjustment:</strong> You entered <span id="inflationNoteToday">$20K</span>/month in today's dollars.
          With 3% annual inflation over <span id="inflationNoteYears">20</span> years, that becomes <span id="inflationNoteFuture">$36K</span>/month at retirement.
        </div>
        <h4>Annual Withdrawal Breakdown (Married Filing Jointly)</h4>
        <table class="data-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Annual Withdrawal (Golden Number)</td>
              <td class="gold" id="taxGrossWithdrawal">$400,000</td>
            </tr>
            <tr>
              <td id="taxFederalLabel">Federal Tax (Bracket: 32%, Effective: 20.8%)</td>
              <td class="red" id="taxFederal">-$83,373</td>
            </tr>
            <tr>
              <td id="taxStateLabel">California Tax (Bracket: 9.3%, Effective: 7.6%)</td>
              <td class="red" id="taxState">-$30,506</td>
            </tr>
            <tr class="total-row">
              <td id="taxEffectiveLabel">Annual After-Tax Spending (Effective Rate: 28.5%)</td>
              <td class="highlight" id="taxNetSpending">$286,121</td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top: var(--space-4); padding: var(--space-4); background: var(--color-bg-tertiary); border-radius: var(--radius-md); font-size: 0.8rem; color: var(--color-text-tertiary);">
          <strong>Progressive Tax Note:</strong> Tax brackets show your marginal rate (rate on the last dollar).
          Effective rate is what you actually pay overall due to progressive taxation.
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-top: var(--space-6);">
          <div class="big-number">
            <div class="label" id="monthlySpendingLabel">Monthly (Future Dollars at 60)</div>
            <div class="amount green" id="monthlySpending">$23,843</div>
            <div class="subtitle" id="monthlyTodayEquiv">â‰ˆ $20K in today's dollars</div>
          </div>
          <div class="big-number">
            <div class="label">30-Year Total Spending</div>
            <div class="amount gold" id="totalSpending30yr">$8.6M</div>
          </div>
        </div>
      </div>

      <!-- 5. What's Left at 90 -->
      <h2 class="section-title"><span class="number">5</span> Retirement: Spending + Growing (Age 60-90)</h2>
      <div class="card">
        <h4 id="section5Title">Each Year: Withdraw $400K, Then Grow Remainder at 8%</h4>

        <div class="big-number">
          <div class="label">Remaining Balance at Age 90</div>
          <div class="amount" id="bigRemaining">$2.1M</div>
          <div class="subtitle" id="remainingSubtitle">You won't run out of money!</div>
        </div>

        <table class="data-table" id="decumulationSummary">
          <thead>
            <tr>
              <th>30 Years of Retirement</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Starting Balance at 60</td>
              <td id="summaryStart">$3,622,000</td>
            </tr>
            <tr>
              <td id="summaryWithdrawnLabel">Total Withdrawn (30 years Ã— $400K)</td>
              <td class="red" id="summaryWithdrawn">-$12,000,000</td>
            </tr>
            <tr>
              <td>Total Growth During Retirement (8%/yr on remainder)</td>
              <td class="blue" id="summaryGrowth">+$10,500,000</td>
            </tr>
            <tr class="total-row">
              <td>Remaining at 90</td>
              <td id="summaryRemaining">$2,122,000</td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top: var(--space-4); padding: var(--space-4); background: var(--color-bg-tertiary); border-radius: var(--radius-md); font-size: 0.875rem; color: var(--color-text-secondary);" id="howItWorksBox">
          <strong>How it works:</strong> Each year you withdraw <span id="howItWorksAmount">$400K</span> for living expenses,
          then your remaining balance grows 8%. This is why you can withdraw more than your starting balance â€”
          your money keeps working for you even in retirement.
        </div>

        <!-- Decumulation Chart -->
        <div style="margin-top: var(--space-6);">
          <h4>Year-by-Year Balance (Age 60-90)</h4>
          <div class="chart-container" style="height: 350px;">
            <canvas id="decumulationChart"></canvas>
          </div>
        </div>
      </div>

      <!-- 6. The Full Picture (Chart) -->
      <h2 class="section-title"><span class="number">6</span> The Full Picture</h2>
      <div class="card">
        <h4>Your Wealth Journey: Today â†’ 60 â†’ 90</h4>
        <div class="chart-container">
          <canvas id="wealthChart"></canvas>
        </div>
      </div>

      </div><!-- End detailed-calculations -->

    </section>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <div class="disclaimer">
      <strong>Disclaimer:</strong> This calculator provides estimates for educational purposes only.
      Actual results depend on market conditions, tax law changes, and individual circumstances.
      The 8% growth assumption is optimistic â€” actual returns may vary significantly.
      Consult a qualified financial advisor for personalized advice.
    </div>
    <p>
      401k Pundit by <a href="/">Neel Labs</a> Â·
      <em>When enough is enough</em>
    </p>
  </footer>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONSTANTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const RETIREMENT_AGE = 60;
    const LIFE_EXPECTANCY = 90;
    const ANNUAL_GROWTH_RATE = 0.08;
    const MONTHLY_GROWTH_RATE = ANNUAL_GROWTH_RATE / 12; // ~0.00667
    const INFLATION_RATE = 0.03; // 3% historical average inflation
    const ANNUAL_IRA_CONTRIBUTION = 47000; // ~$23.5K Ã— 2 for couple (401k/IRA)
    const ANNUAL_ROTH_CONTRIBUTION = 14000; // $7K Ã— 2 for couple (Roth IRA)
    const MONTHLY_IRA_CONTRIBUTION = ANNUAL_IRA_CONTRIBUTION / 12;
    const MONTHLY_ROTH_CONTRIBUTION = ANNUAL_ROTH_CONTRIBUTION / 12;

    // Withdrawal ratios (80% IRA, 20% Roth)
    const IRA_WITHDRAWAL_RATIO = 0.80;
    const ROTH_WITHDRAWAL_RATIO = 0.20;

    // 2024 Federal Tax Brackets - Married Filing Jointly
    const FEDERAL_BRACKETS = [
      { min: 0, max: 23200, rate: 0.10 },
      { min: 23200, max: 94300, rate: 0.12 },
      { min: 94300, max: 201050, rate: 0.22 },
      { min: 201050, max: 383900, rate: 0.24 },
      { min: 383900, max: 487450, rate: 0.32 },
      { min: 487450, max: 731200, rate: 0.35 },
      { min: 731200, max: Infinity, rate: 0.37 }
    ];

    // 2024 California Tax Brackets - Married Filing Jointly
    const CA_BRACKETS = [
      { min: 0, max: 20824, rate: 0.01 },
      { min: 20824, max: 49368, rate: 0.02 },
      { min: 49368, max: 77918, rate: 0.04 },
      { min: 77918, max: 108162, rate: 0.06 },
      { min: 108162, max: 136700, rate: 0.08 },
      { min: 136700, max: 698274, rate: 0.093 },
      { min: 698274, max: 837922, rate: 0.103 },
      { min: 837922, max: 1000000, rate: 0.113 },
      { min: 1000000, max: Infinity, rate: 0.123 }
    ];

    let wealthChart = null;
    let decumulationChart = null;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAX CALCULATION FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * Calculate tax using progressive brackets
     * Returns { tax, effectiveRate, bracketBreakdown }
     */
    function calculateProgressiveTax(income, brackets) {
      let totalTax = 0;
      const breakdown = [];

      for (const bracket of brackets) {
        if (income <= bracket.min) break;

        const taxableInBracket = Math.min(income, bracket.max) - bracket.min;
        const taxInBracket = taxableInBracket * bracket.rate;
        totalTax += taxInBracket;

        if (taxableInBracket > 0) {
          breakdown.push({
            range: `$${bracket.min.toLocaleString()} - $${bracket.max === Infinity ? 'âˆ' : bracket.max.toLocaleString()}`,
            rate: bracket.rate,
            taxable: taxableInBracket,
            tax: taxInBracket
          });
        }
      }

      return {
        tax: totalTax,
        effectiveRate: income > 0 ? totalTax / income : 0,
        breakdown
      };
    }

    /**
     * Calculate both federal and state taxes
     */
    function calculateTotalTax(income) {
      const federal = calculateProgressiveTax(income, FEDERAL_BRACKETS);
      const state = calculateProgressiveTax(income, CA_BRACKETS);

      return {
        federal,
        state,
        totalTax: federal.tax + state.tax,
        effectiveRate: income > 0 ? (federal.tax + state.tax) / income : 0,
        afterTax: income - federal.tax - state.tax
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function toggleDetails() {
      const details = document.getElementById('detailedCalculations');
      const icon = document.getElementById('toggleIcon');
      const btn = document.querySelector('.toggle-details-btn');

      if (details.classList.contains('visible')) {
        details.classList.remove('visible');
        icon.textContent = 'â–¼';
        btn.innerHTML = '<span id="toggleIcon">â–¼</span> Show Detailed Calculations';
      } else {
        details.classList.add('visible');
        icon.textContent = 'â–²';
        btn.innerHTML = '<span id="toggleIcon">â–²</span> Hide Detailed Calculations';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITY FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function formatNumber(input) {
      let value = input.value.replace(/[^\d]/g, '');
      if (value) {
        input.value = parseInt(value).toLocaleString();
      }
    }

    function parseNumber(str) {
      return parseFloat(str.replace(/[^\d.-]/g, '')) || 0;
    }

    // Store the calculated IRA withdrawal amount
    let calculatedIraWithdrawal = 230000; // Default

    function isInflationAdjusted() {
      return document.getElementById('inflationToggle').checked;
    }

    function getDesiredMonthlySpending() {
      // Returns monthly spending in TODAY's dollars (what user entered)
      return parseNumber(document.getElementById('monthlySpendingInput').value) || 20000;
    }

    function getInflationAdjustedMonthlySpending() {
      // Returns monthly spending in FUTURE dollars (at retirement)
      // If inflation toggle is OFF, just return today's dollars
      if (!isInflationAdjusted()) {
        return getDesiredMonthlySpending();
      }

      const currentAge = parseInt(document.getElementById('currentAge').value) || 40;
      const yearsToRetirement = Math.max(0, RETIREMENT_AGE - currentAge);
      const todaysDollars = getDesiredMonthlySpending();

      // Apply inflation: Future $ = Today's $ Ã— (1 + inflation)^years
      const futureDollars = todaysDollars * Math.pow(1 + INFLATION_RATE, yearsToRetirement);
      return futureDollars;
    }

    function getIraWithdrawal() {
      return calculatedIraWithdrawal;
    }

    /**
     * Calculate the IRA withdrawal needed to achieve a desired after-tax monthly spending
     * Uses binary search since tax is progressive
     */
    function calculateIraFromMonthlySpending(desiredMonthlyAfterTax) {
      const desiredAnnualAfterTax = desiredMonthlyAfterTax * 12;

      // Binary search for the IRA withdrawal that gives us the desired after-tax amount
      let low = 0;
      let high = 2000000; // $2M max
      let iterations = 0;
      const maxIterations = 50;

      while (high - low > 100 && iterations < maxIterations) { // Within $100 precision
        const mid = (low + high) / 2;
        const iraWithdrawal = mid;
        const rothWithdrawal = iraWithdrawal * (ROTH_WITHDRAWAL_RATIO / IRA_WITHDRAWAL_RATIO);

        // Calculate after-tax: IRA (taxed) + Roth (tax-free)
        const taxResult = calculateTotalTax(iraWithdrawal);
        const afterTax = taxResult.afterTax + rothWithdrawal;

        if (afterTax < desiredAnnualAfterTax) {
          low = mid;
        } else {
          high = mid;
        }
        iterations++;
      }

      return Math.round((low + high) / 2);
    }

    function updateFromMonthlyInput() {
      const currentAge = parseInt(document.getElementById('currentAge').value) || 40;
      const yearsToRetirement = Math.max(0, RETIREMENT_AGE - currentAge);
      const inflationEnabled = isInflationAdjusted();

      // Get today's dollars and convert to future dollars
      const monthlyTodaysDollars = getDesiredMonthlySpending();
      const monthlyFutureDollars = getInflationAdjustedMonthlySpending();

      // Calculate the IRA withdrawal needed based on spending (future dollars if inflation on)
      calculatedIraWithdrawal = calculateIraFromMonthlySpending(monthlyFutureDollars);
      const rothWithdrawal = calculatedIraWithdrawal * (ROTH_WITHDRAWAL_RATIO / IRA_WITHDRAWAL_RATIO);
      const totalWithdrawal = calculatedIraWithdrawal + rothWithdrawal;

      // Update inflation display (show/hide based on toggle)
      const inflationNote = document.getElementById('inflationNote');
      const spendingLabel = document.getElementById('spendingLabel');

      if (inflationEnabled) {
        inflationNote.style.display = 'block';
        spendingLabel.textContent = "Monthly Spending in Retirement (Today's Dollars, After Taxes)";
        document.getElementById('futureMonthlyDisplay').textContent = formatCurrency(monthlyFutureDollars);
        document.getElementById('yearsToRetireDisplay').textContent = yearsToRetirement;
      } else {
        inflationNote.style.display = 'none';
        spendingLabel.textContent = "Monthly Spending in Retirement (After Taxes)";
      }

      // Update breakdown display
      document.getElementById('iraWithdrawalDisplay').textContent = formatCurrency(calculatedIraWithdrawal);
      document.getElementById('rothWithdrawalDisplay').textContent = formatCurrency(rothWithdrawal);
      document.getElementById('totalWithdrawalDisplay').textContent = formatCurrency(totalWithdrawal);
    }

    function adjustMonthlySpending(amount) {
      const input = document.getElementById('monthlySpendingInput');
      let current = parseNumber(input.value);
      current = Math.max(2000, Math.min(50000, current + amount)); // Min $2K, Max $50K/month
      input.value = current.toLocaleString();
      clearPresetSelection();
      updateFromMonthlyInput();
    }

    function setMonthlyPreset(amount, buttonElement) {
      const input = document.getElementById('monthlySpendingInput');
      input.value = amount.toLocaleString();

      // Update button states
      document.querySelectorAll('.quick-preset-btn').forEach(btn => btn.classList.remove('active'));
      if (buttonElement) {
        buttonElement.classList.add('active');
      }

      updateFromMonthlyInput();
    }

    function clearPresetSelection() {
      document.querySelectorAll('.quick-preset-btn').forEach(btn => btn.classList.remove('active'));
    }

    function formatCurrency(num) {
      if (Math.abs(num) >= 1e6) {
        return '$' + (num / 1e6).toFixed(1) + 'M';
      } else if (Math.abs(num) >= 1e3) {
        return '$' + Math.round(num / 1e3).toLocaleString() + 'K';
      }
      return '$' + num.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }

    function formatFullCurrency(num) {
      return '$' + Math.round(num).toLocaleString();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STOP AGE CALCULATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function simulateWithStopAge(iraBalance, rothBalance, currentAge, stopAge, annualIraWithdrawalAt60, applyInflation = true) {
      // Uses MONTHLY simulation for more accurate results
      // annualIraWithdrawalAt60 is the yearly 401k/IRA portion at age 60 (80% of total)
      // If applyInflation is true, withdrawals increase each year with inflation (True World approach)

      let ira = iraBalance;
      let roth = rothBalance;

      // Phase 1: Accumulation (monthly simulation)
      for (let age = currentAge; age < RETIREMENT_AGE; age++) {
        for (let month = 0; month < 12; month++) {
          // Grow first, then add contributions
          ira *= (1 + MONTHLY_GROWTH_RATE);
          roth *= (1 + MONTHLY_GROWTH_RATE);

          // Add contributions only if before stop age
          if (age < stopAge) {
            ira += MONTHLY_IRA_CONTRIBUTION;
            roth += MONTHLY_ROTH_CONTRIBUTION;
          }
        }
      }

      const iraAt60 = ira;
      const rothAt60 = roth;
      const totalAt60 = ira + roth;

      // Phase 2: Decumulation from 60 to 90 (monthly simulation)
      // Withdrawals start at age 61 (first year of retirement spending)
      // This matches the main calculate() function's logic
      for (let age = RETIREMENT_AGE; age <= LIFE_EXPECTANCY; age++) {
        // Only withdraw after retirement age (ages 61-90)
        if (age > RETIREMENT_AGE) {
          // Calculate this year's withdrawal (inflated from age 60 baseline if enabled)
          const yearsIntoRetirement = age - RETIREMENT_AGE;
          const inflationMultiplier = applyInflation ? Math.pow(1 + INFLATION_RATE, yearsIntoRetirement) : 1;
          const thisYearIraWithdrawal = annualIraWithdrawalAt60 * inflationMultiplier;
          const thisYearRothWithdrawal = thisYearIraWithdrawal * (ROTH_WITHDRAWAL_RATIO / IRA_WITHDRAWAL_RATIO);
          const monthlyIraWithdrawal = thisYearIraWithdrawal / 12;
          const monthlyRothWithdrawal = thisYearRothWithdrawal / 12;

          for (let month = 0; month < 12; month++) {
            // Grow first
            ira *= (1 + MONTHLY_GROWTH_RATE);
            roth *= (1 + MONTHLY_GROWTH_RATE);

            // Withdraw with flexible ratio - if one account runs low, take more from the other
            let iraWithdraw = monthlyIraWithdrawal;
            let rothWithdraw = monthlyRothWithdrawal;

            // If Roth can't cover its share, take more from IRA
            if (roth < rothWithdraw) {
              const shortfall = rothWithdraw - roth;
              rothWithdraw = Math.max(0, roth);
              iraWithdraw += shortfall;
            }

            // If IRA can't cover its share, take more from Roth
            if (ira < iraWithdraw) {
              const shortfall = iraWithdraw - ira;
              iraWithdraw = Math.max(0, ira);
              rothWithdraw += shortfall;
            }

            ira -= iraWithdraw;
            roth -= rothWithdraw;

            // Only "ran out" if BOTH accounts are depleted
            if (ira <= 0 && roth <= 0) {
              const ranOutAge = age + (month / 12);
              return {
                iraAt60, rothAt60, totalAt60,
                iraRemaining: 0,
                rothRemaining: 0,
                totalRemaining: 0,
                ranOut: true,
                ranOutAge: Math.ceil(ranOutAge)
              };
            }
          }
        }
      }

      return {
        iraAt60, rothAt60, totalAt60,
        iraRemaining: ira,
        rothRemaining: roth,
        totalRemaining: ira + roth,
        ranOut: false
      };
    }

    function findOptimalStopAge(iraBalance, rothBalance, currentAge, iraWithdrawal, applyInflation = true) {
      // Find the earliest age where you can stop contributing and still have money at 90

      // Check if already enough (stop contributing now)
      const ifStopNow = simulateWithStopAge(iraBalance, rothBalance, currentAge, currentAge, iraWithdrawal, applyInflation);
      if (!ifStopNow.ranOut && ifStopNow.totalRemaining > 0) {
        return {
          stopAge: currentAge,
          status: 'already-enough',
          ...ifStopNow
        };
      }

      // Search from current age to 60 to find the earliest stop age that works
      for (let stopAge = currentAge; stopAge <= RETIREMENT_AGE; stopAge++) {
        const result = simulateWithStopAge(iraBalance, rothBalance, currentAge, stopAge, iraWithdrawal, applyInflation);

        if (!result.ranOut && result.totalRemaining > 0) {
          return {
            stopAge: stopAge,
            status: 'found',
            ...result
          };
        }
      }

      // If we get here, even contributing till 60 isn't enough
      const ifContributeTill60 = simulateWithStopAge(iraBalance, rothBalance, currentAge, RETIREMENT_AGE, iraWithdrawal, applyInflation);
      return {
        stopAge: RETIREMENT_AGE,
        status: 'need-more',
        ...ifContributeTill60
      };
    }

    /**
     * Find the maximum sustainable monthly spending given balance at retirement
     * Uses binary search to find the highest spending that lasts until 90
     */
    function findSustainableSpending(iraAt60, rothAt60, applyInflation = true) {
      let low = 1000;  // $1K/month minimum
      let high = 50000; // $50K/month maximum
      let iterations = 0;
      const maxIterations = 30;

      while (high - low > 500 && iterations < maxIterations) {
        const mid = (low + high) / 2;
        const iraWithdrawal = calculateIraFromMonthlySpending(mid);

        // Simulate retirement with this spending level
        let ira = iraAt60;
        let roth = rothAt60;
        let ranOut = false;

        for (let age = RETIREMENT_AGE; age <= LIFE_EXPECTANCY; age++) {
          if (age > RETIREMENT_AGE) {
            const yearsIntoRetirement = age - RETIREMENT_AGE;
            const inflationMultiplier = applyInflation ? Math.pow(1 + INFLATION_RATE, yearsIntoRetirement) : 1;
            const thisYearIraWithdrawal = iraWithdrawal * inflationMultiplier;
            const thisYearRothWithdrawal = thisYearIraWithdrawal * (ROTH_WITHDRAWAL_RATIO / IRA_WITHDRAWAL_RATIO);
            const monthlyIra = thisYearIraWithdrawal / 12;
            const monthlyRoth = thisYearRothWithdrawal / 12;

            for (let month = 0; month < 12; month++) {
              ira *= (1 + MONTHLY_GROWTH_RATE);
              roth *= (1 + MONTHLY_GROWTH_RATE);

              let iraW = monthlyIra, rothW = monthlyRoth;
              if (roth < rothW) { iraW += rothW - roth; rothW = Math.max(0, roth); }
              if (ira < iraW) { rothW += iraW - ira; iraW = Math.max(0, ira); }

              ira -= iraW;
              roth -= rothW;

              if (ira <= 0 && roth <= 0) { ranOut = true; break; }
            }
            if (ranOut) break;
          }
        }

        if (ranOut) {
          high = mid; // Too much spending
        } else {
          low = mid; // Can afford this, try higher
        }
        iterations++;
      }

      return Math.floor(low / 1000) * 1000; // Round down to nearest $1K
    }

    /**
     * Find the age you'd need to work until to afford the desired spending
     * Searches beyond age 60 if needed
     */
    function findRequiredWorkAge(iraBalance, rothBalance, currentAge, iraWithdrawal, applyInflation = true) {
      const MAX_WORK_AGE = 75; // Don't search beyond 75

      for (let workUntil = RETIREMENT_AGE + 1; workUntil <= MAX_WORK_AGE; workUntil++) {
        // Simulate: contribute until workUntil, then retire
        let ira = iraBalance;
        let roth = rothBalance;

        // Accumulation phase: current age to workUntil
        for (let age = currentAge; age < workUntil; age++) {
          for (let month = 0; month < 12; month++) {
            ira *= (1 + MONTHLY_GROWTH_RATE);
            roth *= (1 + MONTHLY_GROWTH_RATE);
            ira += MONTHLY_IRA_CONTRIBUTION;
            roth += MONTHLY_ROTH_CONTRIBUTION;
          }
        }

        // Decumulation phase: workUntil to 90
        let ranOut = false;
        const retirementYears = LIFE_EXPECTANCY - workUntil;

        for (let year = 1; year <= retirementYears; year++) {
          const inflationMultiplier = applyInflation ? Math.pow(1 + INFLATION_RATE, year) : 1;
          const thisYearIra = iraWithdrawal * inflationMultiplier;
          const thisYearRoth = thisYearIra * (ROTH_WITHDRAWAL_RATIO / IRA_WITHDRAWAL_RATIO);
          const monthlyIra = thisYearIra / 12;
          const monthlyRoth = thisYearRoth / 12;

          for (let month = 0; month < 12; month++) {
            ira *= (1 + MONTHLY_GROWTH_RATE);
            roth *= (1 + MONTHLY_GROWTH_RATE);

            let iraW = monthlyIra, rothW = monthlyRoth;
            if (roth < rothW) { iraW += rothW - roth; rothW = Math.max(0, roth); }
            if (ira < iraW) { rothW += iraW - ira; iraW = Math.max(0, ira); }

            ira -= iraW;
            roth -= rothW;

            if (ira <= 0 && roth <= 0) { ranOut = true; break; }
          }
          if (ranOut) break;
        }

        if (!ranOut && (ira + roth) > 0) {
          return { found: true, workUntilAge: workUntil };
        }
      }

      return { found: false, workUntilAge: null };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CALCULATION ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function calculate() {
      // First, ensure we have the latest IRA withdrawal calculated from monthly input
      updateFromMonthlyInput();

      // Get inputs
      const currentAge = parseInt(document.getElementById('currentAge').value);
      const iraBalanceStart = parseNumber(document.getElementById('iraBalance').value);
      const rothBalanceStart = parseNumber(document.getElementById('rothBalance').value);
      const iraWithdrawal = getIraWithdrawal(); // Calculated from desired monthly spending
      const inflationEnabled = isInflationAdjusted();

      const totalCurrent = iraBalanceStart + rothBalanceStart;
      const yearsToRetirement = Math.max(0, RETIREMENT_AGE - currentAge);
      const yearsInRetirement = LIFE_EXPECTANCY - RETIREMENT_AGE;

      // Calculate withdrawal amounts (80% IRA, 20% Roth)
      const rothWithdrawal = iraWithdrawal * (ROTH_WITHDRAWAL_RATIO / IRA_WITHDRAWAL_RATIO);
      const totalWithdrawalPerYear = iraWithdrawal + rothWithdrawal;

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // PHASE 1: Accumulation (Current Age â†’ 60) - MONTHLY SIMULATION
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // Track IRA and Roth separately
      let ira = iraBalanceStart;
      let roth = rothBalanceStart;

      // Total contributions for display
      const totalIraContributions = ANNUAL_IRA_CONTRIBUTION * yearsToRetirement;
      const totalRothContributions = ANNUAL_ROTH_CONTRIBUTION * yearsToRetirement;
      const totalContributions = totalIraContributions + totalRothContributions;

      // Simulate accumulation MONTHLY, but record yearly data for charts
      const yearlyData = [];
      for (let age = currentAge; age <= RETIREMENT_AGE; age++) {
        // Record data at start of each year
        yearlyData.push({
          age,
          balance: ira + roth,
          iraBalance: ira,
          rothBalance: roth,
          phase: 'accumulation'
        });

        // Simulate 12 months of growth and contributions
        if (age < RETIREMENT_AGE) {
          for (let month = 0; month < 12; month++) {
            ira *= (1 + MONTHLY_GROWTH_RATE);
            roth *= (1 + MONTHLY_GROWTH_RATE);
            ira += MONTHLY_IRA_CONTRIBUTION;
            roth += MONTHLY_ROTH_CONTRIBUTION;
          }
        }
      }

      const iraAt60 = ira;
      const rothAt60 = roth;
      const balanceAt60 = ira + roth;

      // Calculate growth amounts for display (using monthly compounding formula)
      const monthsToRetirement = yearsToRetirement * 12;
      const iraGrowthOnCurrent = iraBalanceStart * Math.pow(1 + MONTHLY_GROWTH_RATE, monthsToRetirement) - iraBalanceStart;
      const rothGrowthOnCurrent = rothBalanceStart * Math.pow(1 + MONTHLY_GROWTH_RATE, monthsToRetirement) - rothBalanceStart;
      const growthOnCurrent = iraGrowthOnCurrent + rothGrowthOnCurrent;

      // Future value of monthly contributions (annuity formula with monthly compounding)
      let futureValueOfContributions = 0;
      let growthOnContributions = 0;
      if (monthsToRetirement > 0) {
        const monthlyAnnuityFactor = ((Math.pow(1 + MONTHLY_GROWTH_RATE, monthsToRetirement) - 1) / MONTHLY_GROWTH_RATE);
        const iraFV = MONTHLY_IRA_CONTRIBUTION * monthlyAnnuityFactor;
        const rothFV = MONTHLY_ROTH_CONTRIBUTION * monthlyAnnuityFactor;
        futureValueOfContributions = iraFV + rothFV;
        growthOnContributions = futureValueOfContributions - totalContributions;
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // PHASE 2: Decumulation (60 â†’ 90) - MONTHLY SIMULATION
      // If inflation enabled: withdrawals increase each year (True World)
      // If inflation disabled: withdrawals stay constant (Simple mode)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      let totalWithdrawn = 0;
      let totalGrowthInRetirement = 0;
      const decumulationData = [];

      // Base withdrawal amounts at age 60
      const baseIraWithdrawal = iraWithdrawal;
      const baseRothWithdrawal = rothWithdrawal;
      const baseTotalWithdrawal = totalWithdrawalPerYear;

      for (let age = RETIREMENT_AGE; age <= LIFE_EXPECTANCY; age++) {
        const startIra = ira;
        const startRoth = roth;
        const startBalance = ira + roth;
        let yearGrowth = 0;
        let yearWithdrawal = 0;

        if (age > RETIREMENT_AGE) {
          // Calculate this year's withdrawal (inflated if enabled)
          const yearsIntoRetirement = age - RETIREMENT_AGE;
          const inflationMultiplier = inflationEnabled ? Math.pow(1 + INFLATION_RATE, yearsIntoRetirement) : 1;
          const thisYearIraWithdrawal = baseIraWithdrawal * inflationMultiplier;
          const thisYearRothWithdrawal = baseRothWithdrawal * inflationMultiplier;
          const thisYearTotalWithdrawal = baseTotalWithdrawal * inflationMultiplier;
          const monthlyIraWithdrawal = thisYearIraWithdrawal / 12;
          const monthlyRothWithdrawal = thisYearRothWithdrawal / 12;

          // Simulate 12 months: grow then withdraw each month
          for (let month = 0; month < 12; month++) {
            // Grow both accounts
            const iraGrowth = ira * MONTHLY_GROWTH_RATE;
            const rothGrowth = roth * MONTHLY_GROWTH_RATE;
            yearGrowth += iraGrowth + rothGrowth;
            ira += iraGrowth;
            roth += rothGrowth;

            // Withdraw with flexible ratio - if one account runs low, take more from the other
            let iraWithdraw = monthlyIraWithdrawal;
            let rothWithdraw = monthlyRothWithdrawal;

            if (roth < rothWithdraw) {
              const shortfall = rothWithdraw - roth;
              rothWithdraw = Math.max(0, roth);
              iraWithdraw += shortfall;
            }
            if (ira < iraWithdraw) {
              const shortfall = iraWithdraw - ira;
              iraWithdraw = Math.max(0, ira);
              rothWithdraw += shortfall;
            }

            ira -= iraWithdraw;
            roth -= rothWithdraw;
          }

          yearWithdrawal = thisYearTotalWithdrawal;
          totalWithdrawn += thisYearTotalWithdrawal;
          totalGrowthInRetirement += yearGrowth;
        }

        const endBalance = Math.max(0, ira) + Math.max(0, roth);

        yearlyData.push({
          age,
          balance: endBalance,
          iraBalance: Math.max(0, ira),
          rothBalance: Math.max(0, roth),
          phase: 'decumulation'
        });

        decumulationData.push({
          age,
          startBalance: age === RETIREMENT_AGE ? balanceAt60 : startBalance,
          growth: yearGrowth,
          withdrawal: yearWithdrawal,
          endBalance,
          iraBalance: Math.max(0, ira),
          rothBalance: Math.max(0, roth)
        });
      }

      const remainingAt90 = Math.max(0, ira) + Math.max(0, roth);
      const iraRemaining = Math.max(0, ira);
      const rothRemaining = Math.max(0, roth);

      // Calculate spending at age 90 (for display)
      const spendingAt90Multiplier = inflationEnabled ? Math.pow(1 + INFLATION_RATE, 30) : 1;
      const monthlySpendingAt90 = (baseTotalWithdrawal * spendingAt90Multiplier) / 12;

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // UPDATE UI
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // Section 2: Current Balances
      document.getElementById('tableIRA').textContent = formatFullCurrency(iraBalanceStart);
      document.getElementById('tableRoth').textContent = formatFullCurrency(rothBalanceStart);
      document.getElementById('tableTotal').textContent = formatFullCurrency(totalCurrent);

      // Section 3: Projection to 60
      document.getElementById('projYears').textContent = yearsToRetirement;
      document.getElementById('projYears2').textContent = yearsToRetirement;
      document.getElementById('projCurrentBalance').textContent = formatFullCurrency(totalCurrent);
      document.getElementById('projGrowthOnCurrent').textContent = '+' + formatFullCurrency(growthOnCurrent);
      document.getElementById('projContributions').textContent = formatFullCurrency(totalContributions);
      document.getElementById('projGrowthOnContrib').textContent = '+' + formatFullCurrency(growthOnContributions);
      document.getElementById('projTotal').textContent = formatFullCurrency(balanceAt60);
      document.getElementById('bigNestEgg').textContent = formatCurrency(balanceAt60);

      // Section 1 & 4: Tax calculation
      // Update inflation note in Section 4 (show/hide based on toggle)
      const monthlyTodayDollars = getDesiredMonthlySpending();
      const monthlyFutureDollars = getInflationAdjustedMonthlySpending();
      document.getElementById('inflationNoteBox').style.display = inflationEnabled ? 'block' : 'none';
      document.getElementById('inflationNoteToday').textContent = formatCurrency(monthlyTodayDollars);
      document.getElementById('inflationNoteYears').textContent = yearsToRetirement;
      document.getElementById('inflationNoteFuture').textContent = formatCurrency(monthlyFutureDollars);

      // Only IRA withdrawal is taxed; Roth is tax-free
      const taxResult = calculateTotalTax(iraWithdrawal);
      const federalTax = taxResult.federal.tax;
      const stateTax = taxResult.state.tax;
      const iraAfterTax = taxResult.afterTax; // IRA after taxes
      const afterTaxSpending = iraAfterTax + rothWithdrawal; // IRA (taxed) + Roth (tax-free) at age 60
      const monthlyAfterTax = afterTaxSpending / 12;

      // Calculate 30-year total spending (with or without inflation)
      let total30yrSpending;
      if (inflationEnabled) {
        // Geometric series: S = a * (r^n - 1) / (r - 1) where r = 1.03
        const inflationGrowthFactor = (Math.pow(1 + INFLATION_RATE, 30) - 1) / INFLATION_RATE;
        total30yrSpending = afterTaxSpending * inflationGrowthFactor;
      } else {
        total30yrSpending = afterTaxSpending * 30;
      }

      // Effective rate on total withdrawal (including tax-free Roth)
      const totalTaxPaid = federalTax + stateTax;
      const effectiveRateOnTotal = totalWithdrawalPerYear > 0 ? totalTaxPaid / totalWithdrawalPerYear : 0;

      // Find marginal (bracket) rates - the rate on the last dollar
      const federalMarginalRate = taxResult.federal.breakdown.length > 0
        ? taxResult.federal.breakdown[taxResult.federal.breakdown.length - 1].rate
        : 0;
      const stateMarginalRate = taxResult.state.breakdown.length > 0
        ? taxResult.state.breakdown[taxResult.state.breakdown.length - 1].rate
        : 0;

      document.getElementById('assumptionTaxRate').textContent = (effectiveRateOnTotal * 100).toFixed(1) + '%';
      document.getElementById('taxGrossWithdrawal').textContent = formatFullCurrency(totalWithdrawalPerYear);
      document.getElementById('taxFederal').textContent = '-' + formatFullCurrency(federalTax);
      document.getElementById('taxState').textContent = '-' + formatFullCurrency(stateTax);
      document.getElementById('taxNetSpending').textContent = formatFullCurrency(afterTaxSpending);
      document.getElementById('monthlySpending').textContent = formatFullCurrency(monthlyAfterTax);
      document.getElementById('monthlySpendingLabel').textContent = inflationEnabled
        ? 'Monthly (Future Dollars at 60)'
        : 'Monthly Spending';
      document.getElementById('monthlyTodayEquiv').textContent = inflationEnabled
        ? `â‰ˆ ${formatCurrency(getDesiredMonthlySpending())} in today's dollars`
        : '';
      document.getElementById('monthlyTodayEquiv').style.display = inflationEnabled ? 'block' : 'none';
      document.getElementById('totalSpending30yr').textContent = formatCurrency(total30yrSpending);

      // Update labels based on inflation toggle
      document.getElementById('taxFederalLabel').textContent =
        `Federal Tax on IRA (Bracket: ${(federalMarginalRate * 100).toFixed(0)}%, Effective: ${(taxResult.federal.effectiveRate * 100).toFixed(1)}%)`;
      document.getElementById('taxStateLabel').textContent =
        `CA Tax on IRA (Bracket: ${(stateMarginalRate * 100).toFixed(1)}%, Effective: ${(taxResult.state.effectiveRate * 100).toFixed(1)}%)`;
      document.getElementById('taxEffectiveLabel').textContent = inflationEnabled
        ? `After-Tax Spending at 60 (IRA: ${formatCurrency(iraWithdrawal)} taxed + Roth: ${formatCurrency(rothWithdrawal)} tax-free)`
        : `After-Tax Spending (IRA: ${formatCurrency(iraWithdrawal)} taxed + Roth: ${formatCurrency(rothWithdrawal)} tax-free)`;
      document.getElementById('section5Title').textContent = inflationEnabled
        ? `Year 1: Withdraw ${formatCurrency(totalWithdrawalPerYear)}, increasing 3%/year with inflation`
        : `Each Year: Withdraw ${formatCurrency(totalWithdrawalPerYear)}`;
      document.getElementById('summaryWithdrawnLabel').textContent = inflationEnabled
        ? `Total Withdrawn (30 years, increasing 3%/yr)`
        : `Total Withdrawn (30 years Ã— ${formatCurrency(totalWithdrawalPerYear)})`;
      document.getElementById('howItWorksAmount').textContent = inflationEnabled
        ? `${formatCurrency(totalWithdrawalPerYear)} at 60, ${formatCurrency(totalWithdrawalPerYear * spendingAt90Multiplier)} at 90`
        : formatCurrency(totalWithdrawalPerYear);

      // Section 5: What's Left at 90
      document.getElementById('summaryStart').textContent = formatFullCurrency(balanceAt60);
      document.getElementById('summaryWithdrawn').textContent = '-' + formatFullCurrency(totalWithdrawn);
      document.getElementById('summaryGrowth').textContent = '+' + formatFullCurrency(totalGrowthInRetirement);
      document.getElementById('summaryRemaining').textContent = formatFullCurrency(remainingAt90);

      const bigRemaining = document.getElementById('bigRemaining');
      const remainingSubtitle = document.getElementById('remainingSubtitle');
      bigRemaining.textContent = formatCurrency(remainingAt90);

      if (remainingAt90 > 0) {
        bigRemaining.className = 'amount green';
        remainingSubtitle.textContent = "You won't run out of money!";
      } else {
        bigRemaining.className = 'amount red';
        remainingSubtitle.textContent = "Warning: You may run out of money before 90.";
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // THE ANSWER: 3 Scenarios Comparison
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const withdrawalDisplay = formatCurrency(totalWithdrawalPerYear);

      // Scenario 1: What happens if you stop contributing TODAY
      const stopNowResult = simulateWithStopAge(iraBalanceStart, rothBalanceStart, currentAge, currentAge, iraWithdrawal, inflationEnabled);

      // Scenario 2: Find the minimum stop age needed
      const stopAgeResult = findOptimalStopAge(iraBalanceStart, rothBalanceStart, currentAge, iraWithdrawal, inflationEnabled);

      // Scenario 3: Continue to 60 (already calculated as balanceAt60 and remainingAt90)

      // Update Scenario 1: Stop Now
      const scenarioStopNow = document.getElementById('scenarioStopNow');
      const stopNowResultEl = document.getElementById('stopNowResult');
      const stopNowBalance60El = document.getElementById('stopNowBalance60');
      const stopNowRemaining90El = document.getElementById('stopNowRemaining90');

      if (stopNowResult.ranOut) {
        scenarioStopNow.className = 'scenario-card warning';
        stopNowResultEl.innerHTML = `<span class="result-icon">âš ï¸</span><span class="result-text">Run out at age ${stopNowResult.ranOutAge}</span>`;
        stopNowRemaining90El.textContent = '$0';
      } else {
        scenarioStopNow.className = 'scenario-card success';
        stopNowResultEl.innerHTML = `<span class="result-icon">âœ“</span><span class="result-text success">${formatCurrency(stopNowResult.totalRemaining)} left</span>`;
        stopNowRemaining90El.textContent = formatCurrency(stopNowResult.totalRemaining);
      }
      stopNowBalance60El.textContent = formatCurrency(stopNowResult.totalAt60);

      // Update Scenario 2: Minimum Needed
      const minimumAnswerEl = document.getElementById('minimumAnswer');
      const minimumSubtextEl = document.getElementById('minimumSubtext');
      const minimumBalance60El = document.getElementById('minimumBalance60');
      const minimumRemaining90El = document.getElementById('minimumRemaining90');
      const scenarioMinimum = document.getElementById('scenarioMinimum');

      if (stopAgeResult.status === 'already-enough') {
        minimumAnswerEl.textContent = 'NOW!';
        minimumSubtextEl.textContent = 'You already have enough!';
        minimumBalance60El.textContent = formatCurrency(stopAgeResult.totalAt60);
        minimumRemaining90El.textContent = formatCurrency(stopAgeResult.totalRemaining);
        scenarioMinimum.querySelector('.scenario-recommend-badge').textContent = 'Great News!';
        scenarioMinimum.className = 'scenario-card primary'; // Green - good news
      } else if (stopAgeResult.status === 'need-more') {
        // Calculate what they CAN afford
        const sustainableSpending = findSustainableSpending(stopAgeResult.totalAt60 * 0.8, stopAgeResult.totalAt60 * 0.2, inflationEnabled);
        minimumAnswerEl.textContent = formatCurrency(sustainableSpending);
        minimumSubtextEl.textContent = 'per month is sustainable';
        minimumBalance60El.textContent = formatCurrency(stopAgeResult.totalAt60);
        minimumRemaining90El.textContent = 'Lasts to 90';
        scenarioMinimum.querySelector('.scenario-recommend-badge').textContent = 'You Can Afford';
        scenarioMinimum.className = 'scenario-card info'; // Blue - helpful info
      } else {
        const yearsToContribute = stopAgeResult.stopAge - currentAge;
        minimumAnswerEl.textContent = `Age ${stopAgeResult.stopAge}`;
        minimumSubtextEl.textContent = yearsToContribute === 0 ? 'Stop now!' :
          yearsToContribute === 1 ? '1 more year' : `${yearsToContribute} more years`;
        minimumBalance60El.textContent = formatCurrency(stopAgeResult.totalAt60);
        minimumRemaining90El.textContent = formatCurrency(stopAgeResult.totalRemaining);
        scenarioMinimum.querySelector('.scenario-recommend-badge').textContent = 'Minimum Needed';
        scenarioMinimum.className = 'scenario-card primary'; // Green - found the answer
      }

      // Update Scenario 3: Continue to 60
      const scenarioContinue = document.getElementById('scenarioContinue');
      const continueResultEl = document.getElementById('continueResult');
      const continueBalance60El = document.getElementById('continueBalance60');
      const continueRemaining90El = document.getElementById('continueRemaining90');
      const continueHeaderEl = document.getElementById('continueHeader');
      const continueLabel60El = document.getElementById('continueLabel60');
      const continueLabel90El = document.getElementById('continueLabel90');

      if (remainingAt90 > 0) {
        // Normal case: show what happens if they continue to 60
        continueHeaderEl.textContent = 'IF YOU CONTINUE TO 60';
        continueResultEl.innerHTML = `<span class="result-icon">ğŸ¯</span><span class="result-text bonus">${formatCurrency(remainingAt90)} cushion</span>`;
        continueBalance60El.textContent = formatCurrency(balanceAt60);
        continueRemaining90El.textContent = formatCurrency(remainingAt90);
        continueLabel60El.textContent = 'Balance at 60';
        continueLabel90El.textContent = 'Remaining at 90';
        scenarioContinue.className = 'scenario-card bonus'; // Gold - extra cushion
      } else {
        // Need-more case: show what age they'd need to work until
        const requiredWork = findRequiredWorkAge(iraBalanceStart, rothBalanceStart, currentAge, iraWithdrawal, inflationEnabled);
        continueHeaderEl.textContent = 'TO AFFORD THIS GOAL';

        if (requiredWork.found) {
          const extraYears = requiredWork.workUntilAge - RETIREMENT_AGE;
          continueResultEl.innerHTML = `<span class="result-icon">ğŸ“…</span><span class="result-text info">Work until ${requiredWork.workUntilAge}</span>`;
          continueBalance60El.textContent = `+${extraYears} years`;
          continueRemaining90El.textContent = 'Then retire';
          continueLabel60El.textContent = 'Beyond 60';
          continueLabel90El.textContent = 'Required';
        } else {
          continueResultEl.innerHTML = `<span class="result-icon">âš ï¸</span><span class="result-text">Lower spending needed</span>`;
          continueBalance60El.textContent = 'N/A';
          continueRemaining90El.textContent = 'N/A';
          continueLabel60El.textContent = 'Balance at 60';
          continueLabel90El.textContent = 'Remaining at 90';
        }
        scenarioContinue.className = 'scenario-card info'; // Blue - helpful info
      }

      // Update footer with monthly spending focus
      const monthlySpendingToday = getDesiredMonthlySpending();
      const monthlySpendingFuture = getInflationAdjustedMonthlySpending();
      document.getElementById('answerMonthlySpending').textContent = formatCurrency(monthlySpendingToday);
      document.getElementById('answerFutureMonthly').textContent = formatCurrency(monthlySpendingFuture);

      // Update footer text based on inflation mode
      const answerFooter = document.getElementById('answerFooter');
      if (inflationEnabled) {
        answerFooter.innerHTML = `Based on <strong id="answerMonthlySpending">${formatCurrency(monthlySpendingToday)}</strong>/month in today's dollars (<span id="answerFutureMonthly">${formatCurrency(monthlySpendingFuture)}</span>/mo at 60, increasing 3%/yr)`;
      } else {
        answerFooter.innerHTML = `Based on <strong id="answerMonthlySpending">${formatCurrency(monthlySpendingFuture)}</strong>/month spending from age 60-90`;
      }

      // Update Charts
      updateChart(yearlyData, RETIREMENT_AGE);
      updateDecumulationChart(decumulationData, totalWithdrawalPerYear);

      // Show results
      document.getElementById('results').classList.add('visible');
      document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function updateChart(yearlyData, retirementAge) {
      const ctx = document.getElementById('wealthChart').getContext('2d');

      // Prepare data
      const labels = yearlyData.map(d => d.age);
      const balances = yearlyData.map(d => d.balance);

      // Find retirement index
      const retirementIndex = yearlyData.findIndex(d => d.age === retirementAge);

      // Create gradient colors
      const accumulationColor = '#3B82F6';
      const decumulationColor = '#00D632';

      if (wealthChart) {
        wealthChart.destroy();
      }

      wealthChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Portfolio Balance',
            data: balances,
            borderColor: function(context) {
              const index = context.dataIndex;
              return index <= retirementIndex ? accumulationColor : decumulationColor;
            },
            backgroundColor: function(context) {
              const chart = context.chart;
              const { ctx, chartArea } = chart;
              if (!chartArea) return null;

              const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
              gradient.addColorStop(0, 'rgba(0, 214, 50, 0.05)');
              gradient.addColorStop(1, 'rgba(59, 130, 246, 0.2)');
              return gradient;
            },
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#FFFFFF',
            pointHoverBorderColor: '#00D632',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1A1A1A',
              titleColor: '#FFFFFF',
              bodyColor: '#A3A3A3',
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  const age = context[0].label;
                  if (age < retirementAge) {
                    return `Age ${age} (Accumulating)`;
                  } else if (age == retirementAge) {
                    return `Age ${age} (Retirement!)`;
                  } else {
                    return `Age ${age} (Withdrawing)`;
                  }
                },
                label: function(context) {
                  return 'Balance: ' + formatCurrency(context.parsed.y);
                }
              }
            },
            annotation: {
              annotations: {
                retirementLine: {
                  type: 'line',
                  xMin: retirementAge,
                  xMax: retirementAge,
                  borderColor: '#C9A227',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: 'Retirement',
                    position: 'start',
                    backgroundColor: '#C9A227',
                    color: '#000',
                    font: { size: 11, weight: 'bold' }
                  }
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Age',
                color: '#737373',
                font: { size: 12 }
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: {
                color: '#737373',
                maxTicksLimit: 12,
                callback: function(value, index) {
                  const age = this.getLabelForValue(value);
                  if (age === retirementAge) return '60 â˜…';
                  return age;
                }
              }
            },
            y: {
              title: {
                display: true,
                text: 'Portfolio Balance',
                color: '#737373',
                font: { size: 12 }
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: {
                color: '#737373',
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            }
          }
        }
      });
    }

    function updateDecumulationChart(decumulationData, goldenNumber) {
      const ctx = document.getElementById('decumulationChart').getContext('2d');

      // Prepare data - only ages 60-90
      const labels = decumulationData.map(d => d.age);
      const endBalances = decumulationData.map(d => d.endBalance);

      if (decumulationChart) {
        decumulationChart.destroy();
      }

      decumulationChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'End of Year Balance',
            data: endBalances,
            borderColor: '#00D632',
            backgroundColor: function(context) {
              const chart = context.chart;
              const { ctx, chartArea } = chart;
              if (!chartArea) return null;

              const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
              gradient.addColorStop(0, 'rgba(0, 214, 50, 0.02)');
              gradient.addColorStop(1, 'rgba(0, 214, 50, 0.15)');
              return gradient;
            },
            borderWidth: 3,
            fill: true,
            tension: 0.2,
            pointRadius: 4,
            pointBackgroundColor: '#00D632',
            pointBorderColor: '#0D0D0D',
            pointBorderWidth: 2,
            pointHoverRadius: 8,
            pointHoverBackgroundColor: '#FFFFFF',
            pointHoverBorderColor: '#00D632',
            pointHoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1A1A1A',
              titleColor: '#FFFFFF',
              bodyColor: '#A3A3A3',
              borderColor: 'rgba(0, 214, 50, 0.3)',
              borderWidth: 1,
              padding: 16,
              displayColors: false,
              bodySpacing: 6,
              callbacks: {
                title: function(context) {
                  const index = context[0].dataIndex;
                  const age = decumulationData[index].age;
                  if (age === 60) return `Age ${age} â€” Retirement Begins`;
                  if (age === 90) return `Age ${age} â€” End of Projection`;
                  return `Age ${age}`;
                },
                label: function(context) {
                  return null; // We'll use afterBody for custom formatting
                },
                afterBody: function(context) {
                  const index = context[0].dataIndex;
                  const data = decumulationData[index];
                  const lines = [];

                  if (data.age === 60) {
                    lines.push(`Starting Balance: ${formatFullCurrency(data.startBalance)}`);
                  } else {
                    lines.push(`Start of Year: ${formatFullCurrency(data.startBalance)}`);
                    lines.push(`+ Growth (8%): ${formatFullCurrency(data.growth)}`);
                    lines.push(`âˆ’ Withdrawal: ${formatFullCurrency(data.withdrawal)}`);
                    lines.push('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                    lines.push(`End of Year: ${formatFullCurrency(data.endBalance)}`);
                  }

                  return lines;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Age',
                color: '#737373',
                font: { size: 12 }
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: {
                color: '#737373',
                maxTicksLimit: 16,
                callback: function(value, index) {
                  const age = this.getLabelForValue(value);
                  if (age === 60) return '60 â˜…';
                  if (age === 90) return '90';
                  if (age % 5 === 0) return age;
                  return '';
                }
              }
            },
            y: {
              title: {
                display: true,
                text: 'Portfolio Balance',
                color: '#737373',
                font: { size: 12 }
              },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: {
                color: '#737373',
                callback: function(value) {
                  return formatCurrency(value);
                }
              },
              min: 0
            }
          }
        }
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateFromMonthlyInput(); // Initialize the withdrawal breakdown display
      calculate();
    });
  </script>
</body>
</html>
